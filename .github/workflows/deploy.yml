name: Deploy to Nginx Server

on:
  push:
    branches:
      - main
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP (if needed for composer)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      
      # Jika nanti pakai composer, uncomment ini
      # - name: Install Dependencies
      #   run: composer install --no-dev --optimize-autoloader

      - name: Deploy via SFTP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }} # Atau gunakan key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "."
          target: "/var/www/html" # Ganti dengan path folder website di server Anda
          strip_components: 0
          overwrite: true

      - name: Set Permissions (Optional)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            chown -R www-data:www-data /var/www/html
            chmod -R 755 /var/www/html
            chmod -R 777 /var/www/html/public/uploads
